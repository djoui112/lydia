<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Appliance form</title>
  <link rel="stylesheet" href="../../css/ArchiForm.css" />
</head>
<body>

  <div class="page-container" >
  <header class="form-header">
    <button class="back-btn" onclick="goBackWithAgencyId('appliancestyle.html')"><</button>
    <h1>Apply for this agency</h1>
  </header>

  <div class="progress-bar">
    <div class="step completed">1</div>
    <div class="line completed"></div>
    <div class="step completed">2</div>
    <div class="line completed"></div>
    <div class="step active">3</div>
    <div class="line active"></div>
    <div class="step">4</div>
  </div>

  <form class="application-form">
    

    <label>Portfolio</label>
    <input type="url" id="portfolio_url" name="portfolio_url" placeholder="https://portfolio.com" required>

    <label>LinkedIn</label>
    <input type="url" id="linkedin_url" name="linkedin_url" placeholder="https://LinkedIn.com" required>

    <label>Email</label>
    <input type="email" id="email" name="email" placeholder="contact@gmail.com" required>

    <label>Motivation Letter</label>
    <textarea name="motivationLetter" placeholder="your motivation letter" rows="5" required></textarea>

    <button type="button" class="next-btn" onclick="handleApplicationSubmit(event)"> Submit </button>
  </form>
  </div>
  <script src="../../js/form-persistence.js"></script>
  <script src="../../js/form-validation.js"></script>
  <script src="../../js/form-autofill.js"></script>
  <script src="../../js/form-submission.js"></script>
  <script>
    // Handle application form submission
    async function handleApplicationSubmit(event) {
      const form = event.target.closest('form');
      
      // Validate form first
      if (form && typeof validateForm === 'function' && !validateForm(form)) {
        event.preventDefault();
        event.stopPropagation();
        return false;
      }
      
      // Get agency_id from URL and save it
      const urlParams = new URLSearchParams(window.location.search);
      const agencyId = urlParams.get('agency_id') || localStorage.getItem('form-agency-id');
      
      if (!agencyId) {
        alert('Error: Agency ID not found. Please go back to the agency portfolio and click "Apply" again.');
        event.preventDefault();
        event.stopPropagation();
        return false;
      }
      
      if (typeof saveAgencyId === 'function') {
        saveAgencyId(agencyId);
      }
      
      // Save form data before submitting
      if (typeof saveFormData === 'function') {
        saveFormData();
      }
      
      // Save motivation letter from textarea
      const motivationLetter = form.querySelector('textarea[name="motivationLetter"]');
      if (motivationLetter) {
        localStorage.setItem('form-motivationLetter', motivationLetter.value);
      }
      
      // Save portfolio and LinkedIn URLs
      const portfolioUrl = form.querySelector('#portfolio_url');
      if (portfolioUrl) {
        localStorage.setItem('form-portfolio_url', portfolioUrl.value);
      }
      
      const linkedinUrl = form.querySelector('#linkedin_url');
      if (linkedinUrl) {
        localStorage.setItem('form-linkedin_url', linkedinUrl.value);
      }
      
      const email = form.querySelector('#email');
      if (email) {
        localStorage.setItem('form-email', email.value);
      }
      
      // Submit application
      const success = await submitApplication();
      
      if (success) {
        // Navigate to success page
        window.location.href = 'appliance-success.html?agency_id=' + agencyId;
      } else {
        // Error message is already shown by submitApplication
      }
    }
    
    // Helper function to navigate back with agency_id preserved
    function goBackWithAgencyId(page) {
      const urlParams = new URLSearchParams(window.location.search);
      const agencyId = urlParams.get('agency_id') || localStorage.getItem('form-agency-id');
      if (agencyId) {
        window.location.href = `${page}?agency_id=${agencyId}`;
      } else {
        window.location.href = page;
      }
    }
  </script>
</body>
</html>
