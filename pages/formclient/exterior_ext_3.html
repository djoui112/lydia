<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Exterior Project - Step 3</title>
  <link rel="stylesheet" href="../../css/project.css" />
</head>
<body>

  <div class="page-container">
    <header class="form-header">
      <button class="back-btn" onclick="window.location.href='exterior_ext_2.html'"><</button>
      <h1>Exterior Project</h1>
    </header>

    <div class="progress-bar">
      <div class="step completed">1</div>
      <div class="line completed"></div>
      <div class="step completed">2</div>
      <div class="line completed"></div>
      <div class="step completed">3</div>
      <div class="line completed"></div>
      <div class="step completed">4</div>
      <div class="line completed"></div>
      <div class="step active">5</div>
      <div class="line"></div>
      <div class="step">6</div>
    </div>

    <form class="application-form">
      <label>Special Requirements</label>
      <textarea placeholder="Any specific requirements or features you need (e.g., parking, accessibility, energy efficiency)..." rows="4" required></textarea>

      <label>Environmental Considerations</label>
      <input type="text" placeholder="e.g., Solar panels, Green roof, Rainwater collection" required>

      <label>Preferred Contact Method</label>
      <div class="form-group">
        <div class="choice-group">
          <button type="button" class="choice">Phone call</button>
          <button type="button" class="choice">Email</button>
          <button type="button" class="choice">WhatsApp</button>
        </div>
      </div>

      <label>Additional Notes</label>
      <textarea placeholder="Any additional information about your exterior project..." rows="4"></textarea>

      <button type="button" class="next-btn" id="submitBtn" onclick="handleProjectRequestSubmit(event)"> Submit </button>
    </form>
  </div>
  <script src="../../js/project.js"></script>
  <script src="../../js/form-persistence.js"></script>
  <script src="../../js/form-validation.js"></script>
  <script src="../../js/form-submission.js"></script>
  <script>
    // Extract form data from all pages and save with correct keys for submission
    function extractFormDataToSubmissionFormat() {
      console.log('Extracting form data from all pages...');
      
      // Helper function to get value from structured data
      function getValue(data, keys) {
        if (!data || !data.inputs) return null;
        for (const key of keys) {
          if (data.inputs[key] !== undefined && data.inputs[key] !== '') {
            return data.inputs[key];
          }
        }
        return null;
      }
      
      function getChoice(data, keys) {
        if (!data || !data.choices) return null;
        for (const key of keys) {
          if (data.choices[key] && data.choices[key].length > 0) {
            return data.choices[key];
          }
        }
        return null;
      }
      
      // Get data from first page (exteriorproject.html)
      const page1Data = localStorage.getItem('form-exteriorproject');
      if (page1Data) {
        try {
          const data = JSON.parse(page1Data);
          const projectLocation = getValue(data, ['Project location', 'project_location', 'field_2']);
          if (projectLocation) {
            localStorage.setItem('form-project_location', projectLocation);
          }
          const fullName = getValue(data, ['Full name', 'full_name', 'field_0']);
          if (fullName) {
            localStorage.setItem('form-project_name', fullName + ' Project');
          }
          // Extract phone number from form
          const phoneNumber = getValue(data, ['Phone number', 'phone_number', 'field_1']);
          if (phoneNumber) {
            localStorage.setItem('form-phone_number', phoneNumber);
            // Add phone number to description if it's different from account phone
            const currentDesc = localStorage.getItem('form-description') || '';
            if (currentDesc && !currentDesc.includes('Contact Phone:')) {
              localStorage.setItem('form-description', 'Contact Phone: ' + phoneNumber + '\n\n' + currentDesc);
            } else if (!currentDesc) {
              localStorage.setItem('form-description', 'Contact Phone: ' + phoneNumber);
            }
          }
          // Extract email from form
          const email = getValue(data, ['Email', 'email', 'field_3']);
          if (email) {
            localStorage.setItem('form-email', email);
          }
        } catch (e) {
          console.error('Error parsing page 1 data:', e);
        }
      }
      
      // Get data from exterior_ext_1.html
      const ext1Data = localStorage.getItem('form-exterior_ext_1');
      if (ext1Data) {
        try {
          const data = JSON.parse(ext1Data);
          // Project location (if not set from page 1)
          if (!localStorage.getItem('form-project_location')) {
            const projectLocation = getValue(data, ['Project Location', 'project_location', 'field_0']);
            if (projectLocation) localStorage.setItem('form-project_location', projectLocation);
          }
          // Area
          const area = getValue(data, ['Approximate Area', 'approximate_area', 'field_1']);
          if (area) {
            // Extract number from string like "150 m¬≤" or just "150"
            const areaNum = area.toString().replace(/[^\d.]/g, '');
            if (areaNum) localStorage.setItem('form-exterior_area', areaNum);
          }
          // Property type - map to valid enum values
          const propertyType = getChoice(data, ['Property Type', 'property_type']);
          if (propertyType && propertyType.length > 0) {
            const propTypeText = propertyType[0].toLowerCase();
            // Map form values to database enum values
            let mappedType = null;
            if (propTypeText.includes('residential') || propTypeText.includes('facade')) {
              mappedType = 'residential';
            } else if (propTypeText.includes('commercial')) {
              mappedType = 'commercial';
            } else if (propTypeText.includes('landscap') || propTypeText.includes('garden')) {
              mappedType = 'landscape';
            } else if (propTypeText.includes('institutional')) {
              mappedType = 'institutional';
            } else {
              mappedType = 'other';
            }
            localStorage.setItem('form-exterior_property_type', mappedType);
            console.log('Mapped property type:', propTypeText, '->', mappedType);
          }
          // Number of floors
          const floors = getValue(data, ['Number of Floors', 'number_of_floors', 'field_3']);
          if (floors) {
            // Extract number from string like "2 floors" or just "2"
            const floorsNum = floors.toString().replace(/[^\d]/g, '');
            if (floorsNum) localStorage.setItem('form-number_of_floors', floorsNum);
          }
        } catch (e) {
          console.error('Error parsing exterior_ext_1 data:', e);
        }
      }
      
      // Get data from exterior_ext_2.html
      const ext2Data = localStorage.getItem('form-exterior_ext_2');
      if (ext2Data) {
        try {
          const data = JSON.parse(ext2Data);
          // Service type
          const serviceType = getChoice(data, ['Service Type', 'service_type']);
          if (serviceType && serviceType.length > 0) {
            const svcType = serviceType[0].toLowerCase().replace(/\s+/g, '_');
            localStorage.setItem('form-service_type', svcType);
          }
          // Budget
          const minBudget = getValue(data, ['Minimum Budget (in DZD)', 'minBudget', 'min_budget', 'field_1']);
          if (minBudget) localStorage.setItem('form-min_budget', minBudget.toString());
          const maxBudget = getValue(data, ['Maximum Budget (in DZD)', 'maxBudget', 'max_budget', 'field_2']);
          if (maxBudget) localStorage.setItem('form-max_budget', maxBudget.toString());
          // Timeline
          const timeline = getValue(data, ['Preferred Timeline', 'preferred_timeline', 'field_3']);
          if (timeline) localStorage.setItem('form-preferred_timeline', timeline);
          // Style preference
          const style = getValue(data, ['Style Preference', 'style_preference', 'field_4']);
          if (style) localStorage.setItem('form-style_preference', style);
          // Material preferences
          const materials = getChoice(data, ['Material Preferences', 'material_preferences']);
          if (materials && materials.length > 0) {
            localStorage.setItem('form-material_preferences', materials.join(', '));
          }
        } catch (e) {
          console.error('Error parsing exterior_ext_2 data:', e);
        }
      }
      
      console.log('Extracted form data:', {
        project_location: localStorage.getItem('form-project_location'),
        min_budget: localStorage.getItem('form-min_budget'),
        max_budget: localStorage.getItem('form-max_budget'),
        preferred_timeline: localStorage.getItem('form-preferred_timeline'),
        style_preference: localStorage.getItem('form-style_preference'),
        service_type: localStorage.getItem('form-service_type'),
        exterior_property_type: localStorage.getItem('form-exterior_property_type'),
        number_of_floors: localStorage.getItem('form-number_of_floors'),
        exterior_area: localStorage.getItem('form-exterior_area')
      });
    }
    
    // Handle project request form submission
    let isSubmitting = false;
    
    async function handleProjectRequestSubmit(event) {
      // Prevent event from bubbling
      event.preventDefault();
      event.stopPropagation();
      
      // Get button reference IMMEDIATELY
      const submitButton = document.getElementById('submitBtn') || event.target;
      
      // Check if already submitting - check button state FIRST
      if (isSubmitting || submitButton.disabled || (typeof submissionInProgress !== 'undefined' && submissionInProgress)) {
        console.warn('‚ö†Ô∏è Form submission already in progress - BLOCKED');
        return false;
      }
      
      // Set flag IMMEDIATELY - before any other operations
      isSubmitting = true;
      
      // Disable submit button IMMEDIATELY - before any async operations
      const originalText = submitButton.textContent || 'Submit';
      submitButton.disabled = true;
      submitButton.textContent = 'Submitting...';
      submitButton.style.opacity = '0.6';
      submitButton.style.cursor = 'not-allowed';
      
      console.log('üîí Button disabled, submission started');
      
      try {
        const form = event.target.closest('form');
        
        // Validate form first
        if (form && typeof validateForm === 'function' && !validateForm(form)) {
          isSubmitting = false;
          submitButton.disabled = false;
          submitButton.textContent = originalText;
          submitButton.style.opacity = '1';
          submitButton.style.cursor = 'pointer';
          return false;
        }
        
        // Save form data before submitting
        if (typeof saveFormData === 'function') {
          saveFormData();
        }
        
        // Extract and save form data with correct keys for submission
        extractFormDataToSubmissionFormat();
        
        // Get agency_id from URL or localStorage (like appliance form does)
        const urlParams = new URLSearchParams(window.location.search);
        const agencyId = urlParams.get('agency_id') || localStorage.getItem('form-agency-id');
        
        if (!agencyId) {
          alert('Error: Agency ID not found. Please go back to the agency portfolio and click "Request Project" again.');
          isSubmitting = false;
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = originalText;
            submitButton.style.opacity = '1';
            submitButton.style.cursor = 'pointer';
          }
          return false;
        }
        
        // Save agency_id to localStorage to ensure it persists
        if (agencyId && typeof saveAgencyId === 'function') {
          saveAgencyId(agencyId);
        }
        
        // Save special requirements and additional notes
        const specialRequirements = form.querySelector('textarea[placeholder*="specific requirements"]');
        const environmentalConsiderations = form.querySelector('input[placeholder*="Solar panels"]');
        const additionalNotes = form.querySelector('textarea[placeholder*="additional information"]');
        const contactMethod = form.querySelector('.choice.active');
        
        // Get existing description (without duplicates)
        let existingDesc = localStorage.getItem('form-description') || '';
        // Remove any existing "Special Requirements", "Environmental Considerations", "Additional Notes" to avoid duplicates
        existingDesc = existingDesc.replace(/Special Requirements:.*?(?=\n\n|$)/g, '').trim();
        existingDesc = existingDesc.replace(/Environmental Considerations:.*?(?=\n\n|$)/g, '').trim();
        existingDesc = existingDesc.replace(/Additional Notes:.*?(?=\n\n|$)/g, '').trim();
        existingDesc = existingDesc.replace(/Contact Method:.*?(?=\n\n|$)/g, '').trim();
        
        // Build description from all text fields - check if already added to avoid duplicates
        let descriptionParts = [];
        
        // Check what's already in the description to avoid duplicates
        const hasSpecialReqs = existingDesc.includes('Special Requirements:');
        const hasEnvConsiderations = existingDesc.includes('Environmental Considerations:');
        const hasAdditionalNotes = existingDesc.includes('Additional Notes:');
        const hasContactMethod = existingDesc.includes('Contact Method:');
        
        if (specialRequirements && specialRequirements.value.trim() && !hasSpecialReqs) {
          localStorage.setItem('form-exterior_special_requirements', specialRequirements.value);
          descriptionParts.push('Special Requirements: ' + specialRequirements.value);
        }
        
        if (environmentalConsiderations && environmentalConsiderations.value.trim() && !hasEnvConsiderations) {
          descriptionParts.push('Environmental Considerations: ' + environmentalConsiderations.value);
        }
        
        if (additionalNotes && additionalNotes.value.trim() && !hasAdditionalNotes) {
          descriptionParts.push('Additional Notes: ' + additionalNotes.value);
        }
        
        if (contactMethod && contactMethod.textContent.trim() && !hasContactMethod) {
          descriptionParts.push('Contact Method: ' + contactMethod.textContent.trim());
        }
        
        // Combine existing description with new parts (only if there are new parts)
        if (descriptionParts.length > 0) {
          const newParts = descriptionParts.join('\n\n');
          const fullDescription = existingDesc ? existingDesc + '\n\n' + newParts : newParts;
          localStorage.setItem('form-description', fullDescription);
          console.log('Saved description (no duplicates):', fullDescription);
        } else {
          // Keep existing description as-is if no new parts
          console.log('No new parts to add, keeping existing description:', existingDesc);
        }
        
        // Submit project request
        console.log('üì§ Calling submitProjectRequest...');
        const success = await submitProjectRequest();
        console.log('üì• submitProjectRequest returned:', success);
        
        if (success) {
          // Mark as submitted to prevent double submission on success page
          sessionStorage.setItem('project-request-submitted', 'true');
          
          // Clear the flag and navigate - DON'T reset flag before navigation
          console.log('‚úÖ Submission successful, navigating to success page');
          
          // Preserve agency_id in URL when navigating to success page (like appliance form does)
          const agencyId = getAgencyId();
          const successUrl = agencyId ? `exterior_ext_success.html?agency_id=${agencyId}` : 'exterior_ext_success.html';
          
          // Navigate immediately - don't reset flag (page will unload anyway)
          window.location.href = successUrl;
          return; // Exit immediately
        } else {
          // Show error message
          console.error('‚ùå Submission returned false');
          isSubmitting = false;
          // Also reset the global flag
          if (typeof submissionInProgress !== 'undefined') {
            submissionInProgress = false;
          }
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = originalText;
            submitButton.style.opacity = '1';
            submitButton.style.cursor = 'pointer';
          }
          // Don't show alert here - submitProjectRequest already shows alerts
        }
      } catch (error) {
        console.error('‚ùå Error in form submission handler:', error);
        console.error('Error stack:', error.stack);
        alert('Error submitting form: ' + error.message);
        isSubmitting = false;
        // Also reset the global flag
        if (typeof submissionInProgress !== 'undefined') {
          submissionInProgress = false;
        }
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = originalText;
          submitButton.style.opacity = '1';
          submitButton.style.cursor = 'pointer';
        }
      }
    }
  </script>
</body>
</html>

