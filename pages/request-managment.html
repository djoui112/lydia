<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="../css/request-management.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
        <link rel="icon" href="../assets/request-managment/logo.png" type="image/png">
        <title>Request Management</title>
    </head>
    <body>
        <header class="site-header">
            <nav class="top-nav">
                <a href="javascript:history.back()" class="back-button" aria-label="Go back">
                    <i class="fa-solid fa-arrow-left" aria-hidden="true"></i>
                </a>
                <h1 class="title">Request Management</h1>
                <div class="search-container">
                    <i class="fa fa-search" aria-hidden="true"></i>
                    <input type="search" placeholder="Search request, client, location" aria-label="Search requests">
                </div>
            </nav>
        </header>

        <main class="page-shell">
            <section class="team-page" aria-label="Projects">
                <div class="card-grid container" id="projectsGrid"></div>
            </section>
        </main>

        <footer class="footer">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="footer-logo">
                        <svg
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                            xmlns="http://www.w3.org/2000/svg"
                        >
                            <path
                                d="M12 2L2 7V17L12 22L22 17V7L12 2Z"
                                stroke="white"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            />
                            <path
                                d="M12 22V12"
                                stroke="white"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            />
                            <path
                                d="M2 7L12 12L22 7"
                                stroke="white"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            />
                        </svg>
                        <span>mimaria</span>
                    </div>
                    <p class="footer-tagline">
                        Design, Build, Network all in one place
                    </p>
                </div>
                <div class="footer-section">
                    <nav class="footer-nav">
                        <a href="agency-interface.html#data-section">Recent Data & Deadlines</a>
                        <a href="agency-interface.html#team-management">Team Management</a>
                        <a href="agency-interface.html#project-management">Project Management</a>
                        <a href="agency-interface.html#portfolio-section">View Portfolio</a>
                    </nav>
                </div>
                <div class="footer-section">
                <div class="footer-contact">
                        <div class="contact-item">
                            <svg
                                width="20"
                                height="20"
                                viewBox="0 0 24 24"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                            >
                                <path
                                    d="M21 11.5C21.0034 12.8199 20.6951 14.1219 20.1 15.3C19.3944 16.7118 18.3098 17.8992 16.9674 18.7293C15.6251 19.5594 14.0782 19.9994 12.5 20C11.1801 20.0035 9.87812 19.6951 8.7 19.1L3 21L4.9 15.3C4.30493 14.1219 3.99656 12.8199 4 11.5C4.00061 9.92179 4.44061 8.37488 5.27072 7.03258C6.10083 5.69028 7.28825 4.6056 8.7 3.90003C9.87812 3.30496 11.1801 2.99659 12.5 3.00003H13C15.0843 3.11502 17.053 3.99479 18.5291 5.47089C20.0052 6.94699 20.885 8.91568 21 11V11.5Z"
                                    stroke="white"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                />
                            </svg>
                            <span>+21355000053</span>
                        </div>
                        <div class="contact-item">
                            <svg
                                width="20"
                                height="20"
                                viewBox="0 0 24 24"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                            >
                                <rect
                                    x="2"
                                    y="2"
                                    width="20"
                                    height="20"
                                    rx="5"
                                    stroke="white"
                                    stroke-width="2"
                                />
                                <path
                                    d="M16 11.37C16.1234 12.2022 15.9813 13.0522 15.5938 13.799C15.2063 14.5458 14.5931 15.1514 13.8416 15.5297C13.0901 15.908 12.2384 16.0396 11.4078 15.9059C10.5771 15.7723 9.80976 15.3801 9.21484 14.7851C8.61993 14.1901 8.22768 13.4229 8.09402 12.5922C7.96035 11.7616 8.09202 10.9099 8.47032 10.1584C8.84862 9.40686 9.45419 8.7937 10.201 8.40624C10.9478 8.01878 11.7978 7.87665 12.63 8.00003C13.4789 8.12594 14.2648 8.52152 14.8717 9.12836C15.4785 9.73521 15.8741 10.5211 16 11.37Z"
                                    stroke="white"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                />
                                <path
                                    d="M17.5 6.5H17.51"
                                    stroke="white"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                />
                            </svg>
                            <span>Mimaria_platform</span>
                        </div>
                        <div class="contact-item">
                            <svg
                                width="20"
                                height="20"
                                viewBox="0 0 24 24"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                            >
                                <path
                                    d="M16 8C17.5913 8 19.1174 8.63214 20.2426 9.75736C21.3679 10.8826 22 12.4087 22 14V21H18V14C18 13.4696 17.7893 12.9609 17.4142 12.5858C17.0391 12.2107 16.5304 12 16 12C15.4696 12 14.9609 12.2107 14.5858 12.5858C14.2107 12.9609 14 13.4696 14 14V21H10V14C10 12.4087 10.6321 10.8826 11.7574 9.75736C12.8826 8.63214 14.4087 8 16 8Z"
                                    stroke="white"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                />
                                <path
                                    d="M6 9H2V21H6V9Z"
                                    stroke="white"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                />
                                <path
                                    d="M4 6C5.10457 6 6 5.10457 6 4C6 2.89543 5.10457 2 4 2C2.89543 2 2 2.89543 2 4C2 5.10457 2.89543 6 4 6Z"
                                    stroke="white"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                />
                            </svg>
                            <span>Mimaria official</span>
                        </div>
                        <div class="contact-item">
                            <svg
                                width="20"
                                height="20"
                                viewBox="0 0 24 24"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                            >
                                <path
                                    d="M4 4H20C21.1 4 22 4.9 22 6V18C22 19.1 21.1 20 20 20H4C2.9 20 2 19.1 2 18V6C2 4.9 2.9 4 4 4Z"
                                    stroke="white"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                />
                                <path
                                    d="M22 6L12 13L2 6"
                                    stroke="white"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                />
                            </svg>
                            <span>Mimaria.platform@gmail.com</span>
                        </div>
                    </div>
                </div>
            </div>
        </footer>

        <script>
            document.addEventListener("DOMContentLoaded", async () => {
                console.log("JS LOADED");
                const grid = document.getElementById("projectsGrid");
                const searchInput = document.querySelector(".search-container input");
                
                // First, verify user is logged in and is an agency
                try {
                    const profileRes = await fetch('../php/api/users/profile.php', {
                        credentials: 'include'
                    });
                    
                    if (profileRes.ok) {
                        const profileData = await profileRes.json();
                        console.log('Profile data:', profileData);
                        
                        if (profileData.success && profileData.data?.user?.user_type === 'agency') {
                            console.log('User is logged in as agency:', profileData.data.user);
                        } else {
                            grid.innerHTML = '<p>You must be logged in as an agency to view requests. <a href="login/login.html">Log in</a></p>';
                            return;
                        }
                    } else {
                        console.error('Profile check failed:', profileRes.status);
                        grid.innerHTML = '<p>Please <a href="login/login.html">log in</a> as an agency first.</p>';
                        return;
                    }
                } catch (err) {
                    console.error('Error checking profile:', err);
                    grid.innerHTML = '<p>Error verifying login. Please <a href="login/login.html">log in</a> again.</p>';
                    return;
                }

                function renderProjects(projects) {
                    grid.innerHTML = "";

                    if (projects.length === 0) {
                        grid.innerHTML = "<p>No projects found</p>";
                        return;
                    }

                    projects.forEach(project => {
                        grid.innerHTML += `
                            <article class="agency-card">
                                <div class="agency-card__arch">
                                    <h3>${project.project_name}</h3>
                                    <p>${project.client_name}</p>
                                </div>
                                <div class="agency-card__body">
                                    <p>${project.description}</p>
                                    <a href="c_reqpreview.html?id=${project.id}" class="btn">See more</a>
                                </div>
                            </article>
                        `;
                    });
                }

                function loadProjects(query = "") {
                    const url = `../php/api/search/requests.php?query=${encodeURIComponent(query)}`;
                    console.log('Loading requests from:', url);
                    console.log('Session check - cookies:', document.cookie);
                    
                    fetch(url, {
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                        .then(res => {
                            console.log('Response status:', res.status, res.statusText);
                            console.log('Response headers:', [...res.headers.entries()]);
                            
                            if (res.status === 401) {
                                throw new Error('Not logged in. Please log in as an agency first.');
                            }
                            
                            if (res.status === 403) {
                                throw new Error('Access denied. You must be logged in as an agency.');
                            }
                            
                            if (!res.ok) {
                                throw new Error(`HTTP error! status: ${res.status} ${res.statusText}`);
                            }
                            
                            // Check if response is JSON
                            const contentType = res.headers.get('content-type');
                            if (!contentType || !contentType.includes('application/json')) {
                                return res.text().then(text => {
                                    console.error('Non-JSON response:', text.substring(0, 500));
                                    throw new Error('Server returned invalid response format');
                                });
                            }
                            
                            return res.json();
                        })
                        .then(data => {
                            console.log('Requests loaded:', data);
                            if (!Array.isArray(data)) {
                                throw new Error('Invalid response format: expected array');
                            }
                            renderProjects(data);
                        })
                        .catch(err => {
                            console.error('Error loading requests:', err);
                            grid.innerHTML = `<p>Error loading requests: ${err.message}. Please check console for details.</p>`;
                        });
                }

                // load all projects on page load
                loadProjects();

                // live search
                searchInput.addEventListener("input", () => {
                    loadProjects(searchInput.value);
                });
            });
        </script>
    </body>
</html>

